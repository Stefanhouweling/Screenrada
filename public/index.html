<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Screen Reader AI – Stable Release</title>
  <style>
    :root{--bg:#0b0b0c;--ink:#fff;--muted:#9aa0a6;--panel:#121316;--stroke:#2a2b2f;--brand:#2c7be5;--ok:#0fa77a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,sans-serif}
    .app{height:100dvh;display:grid;grid-template-rows:1fr 1fr}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .bottom{padding:10px;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button{border:none;border-radius:10px;padding:10px 12px}
    button{background:var(--brand);color:#fff}
    #askNow{background:var(--ok)}
    .meta{font-size:12px;opacity:.9}
    .panes{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pane{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .big{font-weight:800;font-size:28px}
    .muted{opacity:.9;font-size:12px}
    .answer{border:1px solid var(--stroke);border-radius:10px;padding:10px;background:#0e0f12;min-height:80px}
    @media (max-width:800px){.panes{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <section class="top"><video id="cam" autoplay playsinline muted></video></section>
    <section class="bottom">
      <div class="row">
        <button id="startCam">Start Camera</button>
        <button id="askNow">Ask Now</button>
        <label class="meta" style="margin-left:auto"><input id="autoSend" type="checkbox" checked> Auto-send</label>
      </div>
      <div class="row meta">
        <span id="status">Status: idle</span>
        <span id="note"> • Server handles /ask on this same domain</span>
      </div>
      <div class="panes">
        <div class="pane">
          <div class="muted">Working</div>
          <div id="workingBig" class="answer big">No response</div>
          <div id="workingRat" class="answer muted" style="min-height:40px"></div>
        </div>
        <div class="pane">
          <div class="muted">Locked</div>
          <div id="lockedBig" class="answer big">–</div>
          <div id="lockedRat" class="answer muted" style="min-height:40px"></div>
        </div>
      </div>
    </section>
  </div>

  <canvas id="frame" width="640" height="480" style="display:none"></canvas>
  <script>
    const video=document.getElementById('cam'),startCam=document.getElementById('startCam'),askNow=document.getElementById('askNow');
    const statusEl=document.getElementById('status'),frame=document.getElementById('frame'),ctx=frame.getContext('2d');
    const workingBig=document.getElementById('workingBig'),workingRat=document.getElementById('workingRat');
    const lockedBig=document.getElementById('lockedBig'),lockedRat=document.getElementById('lockedRat');
    const autoSend=document.getElementById('autoSend');

    async function startCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}});
        video.srcObject=stream; await video.play();
        frame.width=video.videoWidth||640; frame.height=video.videoHeight||480;
        statusEl.textContent='Status: camera running';
        loop();
      }catch(e){ alert('Camera permission denied or page not using HTTPS'); console.error(e); }
    }
    startCam.onclick=startCamera;

    let busy=false,lastSent=0;
    function loop(){
      ctx.drawImage(video,0,0,frame.width,frame.height);
      if(autoSend.checked && !busy && Date.now()-lastSent>2000){ captureAndSend(); }
      requestAnimationFrame(loop);
    }
    askNow.onclick=captureAndSend;

    async function captureAndSend(){
      if(busy) return; busy=true; lastSent=Date.now();
      const base64=frame.toDataURL('image/png').split(',')[1];
      statusEl.textContent='Sending image to AI...';
      try{
        const r=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64:base64})});
        const data=await r.json();
        const txt=data.choices?.[0]?.message?.content||'{}';
        let obj={}; try{ obj=JSON.parse(txt); }catch(_){ obj={answer:txt}; }
        workingBig.textContent=obj.answer||'No answer';
        workingRat.textContent=obj.rationale||'';
        lockedBig.textContent=obj.answer||'No answer';
        lockedRat.textContent=obj.rationale||'';
        statusEl.textContent='Answer received';
      }catch(e){
        workingBig.textContent='Error'; workingRat.textContent=e.message||String(e);
        statusEl.textContent='Upload failed';
      }finally{ busy=false; }
    }
  </script>
</body>
</html>
