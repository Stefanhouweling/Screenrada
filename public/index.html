<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Screenrada ‚Äì Vision AI</title>
  <style>
    :root{--bg:#0b0b0c;--ink:#fff;--muted:#9aa0a6;--panel:#121316;--stroke:#2a2b2f;--brand:#2c7be5;--ok:#0fa77a;--err:#e55353;--warn:#f5a623}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,sans-serif}
    .app{height:100dvh;display:grid;grid-template-rows:1fr 1.05fr}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .bottom{padding:10px;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{font-size:12px;opacity:.9}
    .panes{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pane{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .big{font-weight:800;font-size:28px}.muted{opacity:.9;font-size:12px}
    .answer{border:1px solid var(--stroke);border-radius:10px;padding:10px;background:#0e0f12;min-height:80px}
    .pbar{position:relative;width:200px;height:6px;border-radius:999px;background:#1a1b1f;border:1px solid #2a2b2f;overflow:hidden}
    .pbar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),#6aa6ff);transition:width .15s}
    .err{color:var(--err)}.warn{color:var(--warn)}.ok{color:var(--ok)}
    .speed-indicator{font-size:18px;margin-left:auto}
    .timer{font-weight:700;color:var(--brand)}
    @media(max-width:800px){.panes{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <section class="top"><video id="cam" autoplay playsinline muted></video></section>
    <section class="bottom">
      <div class="row meta" style="gap:12px">
        <span id="emoji">üí§ Idle</span><span id="hashNote"></span><span id="cooldownNote"></span>
        <div class="pbar"><i id="pfill"></i></div><span id="ppct">0%</span>
        <span id="timer" class="timer"></span>
        <span id="speed" class="speed-indicator">üö¶</span>
        <span id="net" style="margin-left:4px">Status: idle</span>
      </div>
      <div class="panes">
        <div class="pane"><div class="muted">Working</div><div id="workingBig" class="answer big">No response</div><div id="workingRat" class="answer muted"></div></div>
        <div class="pane"><div class="muted">Locked</div><div id="lockedBig" class="answer big">‚Äì</div><div id="lockedRat" class="answer muted"></div></div>
      </div>
    </section>
  </div>

  <canvas id="frame" width="640" height="480" style="display:none"></canvas>
  <script>
    const v=document.getElementById('cam'),f=document.getElementById('frame'),ctx=f.getContext('2d',{willReadFrequently:true});
    const workingBig=document.getElementById('workingBig'),workingRat=document.getElementById('workingRat');
    const lockedBig=document.getElementById('lockedBig'),lockedRat=document.getElementById('lockedRat');
    const emoji=document.getElementById('emoji'),hashNote=document.getElementById('hashNote'),cooldownNote=document.getElementById('cooldownNote');
    const pfill=document.getElementById('pfill'),ppct=document.getElementById('ppct'),net=document.getElementById('net'),speed=document.getElementById('speed');
    const timer=document.getElementById('timer');
    
    const GRID=6,CHANGE_THRESHOLD=.18,NEW_Q_THRESHOLD=.25,STABLE_FRAMES=3,MIN_INTERVAL_MS=3000;
    let MAX_SEND_WIDTH=768;
    let busy=false,lastSent=0,stableCount=0,lastHash='',lockedHash='',lockedAnswer=null;
    let uploadSpeeds=[],currentSpeed='unknown',restartTimeout=null,requestStartTime=0;

    function paintNet(){
      const online=navigator.onLine;
      net.textContent=online?'Status: online':'Status: offline';
      net.classList.toggle('err',!online);
      if(!online)speed.textContent='üî¥';
    }
    addEventListener('online',paintNet);addEventListener('offline',paintNet);paintNet();

    function updateSpeedIndicator(){
      if(!navigator.onLine){speed.textContent='üî¥';return}
      const avg=uploadSpeeds.length?uploadSpeeds.reduce((a,b)=>a+b)/uploadSpeeds.length:0;
      if(avg>400){speed.textContent='üü¢';currentSpeed='fast';MAX_SEND_WIDTH=896}
      else if(avg>200){speed.textContent='üü°';currentSpeed='medium';MAX_SEND_WIDTH=768}
      else{speed.textContent='üî¥';currentSpeed='slow';MAX_SEND_WIDTH=640}
    }

    function setState(k,extra=''){
      const m={
        asking:'üü¢ Question detected ‚Äî asking AI',
        newq:'üü° New question detected ‚Äî sending‚Ä¶',
        nonew:'üîµ No new question',
        error:'üî¥ Error / retrying',
        idle:'üí§ Idle'
      };
      emoji.textContent=m[k]||'‚ÑπÔ∏è';
      if(extra)emoji.textContent+=' '+extra;
      clearTimeout(restartTimeout);
      if(k==='error')restartTimeout=setTimeout(()=>{busy=false;setState('idle');console.log('Auto-restarting after error')},5000);
    }

    async function startCam(){
      try{
        const s=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}
        });
        v.srcObject=s;
        await v.play();
        f.width=Math.min(v.videoWidth||640,1280);
        f.height=Math.min(v.videoHeight||480,720);
        setState('idle');
        loop();
      }catch(e){
        alert('Camera permission or HTTPS required');
        console.error(e);
      }
    }
    startCam();

    function getHash(){
      const w=f.width,h=f.height,cw=Math.floor(w/GRID),ch=Math.floor(h/GRID);
      const img=ctx.getImageData(0,0,w,h).data;
      let o='';
      for(let gy=0;gy<GRID;gy++)for(let gx=0;gx<GRID;gx++){
        let s=0,c=0,sy=gy*ch,sx=gx*cw;
        for(let y=sy;y<sy+ch&&y<h;y++)for(let x=sx;x<sx+cw&&x<w;x++){
          const i=(y*w+x)*4;
          s+=(img[i]+img[i+1]+img[i+2])/3;
          c++;
        }
        o+=Math.floor(s/c/32);
      }
      return o;
    }

    function diffHash(a,b){
      if(!a||!b||a.length!==b.length)return 1;
      let d=0;
      for(let i=0;i<a.length;i++)if(a[i]!==b[i])d++;
      return d/a.length;
    }

    const cooldownLeft=()=>Math.max(0,MIN_INTERVAL_MS-(Date.now()-lastSent));

    function toBase64Grayscale(){
      const sw=f.width,sc=Math.min(1,MAX_SEND_WIDTH/sw);
      const tw=Math.round(f.width*sc),th=Math.round(f.height*sc);
      const o=document.createElement('canvas');
      o.width=tw;o.height=th;
      const octx=o.getContext('2d');
      
      // Step 1: Draw with image smoothing for better quality
      octx.imageSmoothingEnabled=true;
      octx.imageSmoothingQuality='high';
      octx.drawImage(f,0,0,tw,th);
      
      // Step 2: Get image data for processing
      const imgData=octx.getImageData(0,0,tw,th);
      const d=imgData.data;
      
      // Step 3: Convert to grayscale with contrast enhancement
      for(let i=0;i<d.length;i+=4){
        // Weighted grayscale conversion
        let gray=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
        
        // Increase contrast (makes text sharper)
        gray=((gray-128)*1.3)+128;
        
        // Clamp values
        gray=Math.max(0,Math.min(255,gray));
        
        // Apply slight sharpening for text clarity
        d[i]=d[i+1]=d[i+2]=gray;
      }
      
      // Step 4: Apply sharpening filter for text
      const sharpened=sharpenImage(imgData,tw,th);
      octx.putImageData(sharpened,0,0);
      
      return o.toDataURL('image/png',1.0).split(',')[1];
    }
    
    function sharpenImage(imgData,w,h){
      const d=imgData.data;
      const out=new ImageData(w,h);
      const od=out.data;
      
      // Sharpening kernel (emphasizes edges/text)
      const kernel=[0,-1,0,-1,5,-1,0,-1,0];
      
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          let sum=0;
          for(let ky=-1;ky<=1;ky++){
            for(let kx=-1;kx<=1;kx++){
              const idx=((y+ky)*w+(x+kx))*4;
              const kIdx=(ky+1)*3+(kx+1);
              sum+=d[idx]*kernel[kIdx];
            }
          }
          const i=(y*w+x)*4;
          sum=Math.max(0,Math.min(255,sum));
          od[i]=od[i+1]=od[i+2]=sum;
          od[i+3]=255;
        }
      }
      
      // Copy edges without sharpening
      for(let x=0;x<w;x++){
        for(let edge of[0,h-1]){
          const i=(edge*w+x)*4;
          od[i]=od[i+1]=od[i+2]=d[i];
          od[i+3]=255;
        }
      }
      for(let y=0;y<h;y++){
        for(let edge of[0,w-1]){
          const i=(y*w+edge)*4;
          od[i]=od[i+1]=od[i+2]=d[i];
          od[i+3]=255;
        }
      }
      
      return out;
    }

    function setProgress(p){pfill.style.width=p+'%';ppct.textContent=p+'%'}

    function updateTimer(){
      if(requestStartTime){
        const elapsed=((Date.now()-requestStartTime)/1000).toFixed(1);
        timer.textContent=elapsed+'s';
        if(busy)requestAnimationFrame(updateTimer);
      }
    }

    function loop(){
      ctx.drawImage(v,0,0,f.width,f.height);
      const h=getHash(),d=diffHash(h,lastHash);
      hashNote.textContent=`Œî ${Math.round(d*100)}%`;
      
      if(!busy){
        const cd=cooldownLeft();
        if(cd>0){
          cooldownNote.textContent=`‚è± ${Math.ceil(cd/1000)}s`;
        }else{
          cooldownNote.textContent='';
          
          // Check if this is a NEW question (significant change from locked)
          if(lockedHash){
            const changeFromLocked=diffHash(h,lockedHash);
            if(changeFromLocked<NEW_Q_THRESHOLD){
              // Still the same question - DO NOT re-analyze
              setState('nonew',`(locked)`);
              lastHash=h;
              requestAnimationFrame(loop);
              return;
            }
          }
          
          // New question detected or no locked answer yet
          if(d<CHANGE_THRESHOLD){
            if(++stableCount>=STABLE_FRAMES){
              const isNewQ=lockedHash&&diffHash(h,lockedHash)>NEW_Q_THRESHOLD;
              setState(isNewQ?'newq':'asking');
              send(h);
              stableCount=0;
            }
          }else{
            stableCount=0;
          }
        }
      }
      lastHash=h;
      requestAnimationFrame(loop);
    }

    async function send(cur,retryCount=0){
      busy=true;lastSent=Date.now();requestStartTime=Date.now();setProgress(0);
      updateTimer();
      const base=toBase64Grayscale();
      const sizeKB=(base.length*0.75)/1024;

      try{
        const response=await fetch('/ask',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({imageBase64:base})
        });

        const elapsed=(Date.now()-requestStartTime)/1000;
        const kbps=sizeKB/elapsed;
        uploadSpeeds.push(kbps);
        if(uploadSpeeds.length>5)uploadSpeeds.shift();
        updateSpeedIndicator();
        
        setProgress(100);
        const text=await response.text();
        handle(response.status,text,cur);
      }catch(e){
        if(retryCount<1){
          console.warn("Retrying with lower resolution...");
          MAX_SEND_WIDTH=Math.max(512,MAX_SEND_WIDTH-128);
          setTimeout(()=>send(cur,retryCount+1),800);
        }else{
          err('Upload failed: '+e.message);
        }
      }
    }

    function err(msg){
      busy=false;
      requestStartTime=0;
      timer.textContent='';
      workingBig.textContent='Error';
      workingRat.textContent=msg;
      setState('error',msg);
    }

    function handle(status,text,cur){
      busy=false;
      const totalTime=((Date.now()-requestStartTime)/1000).toFixed(2);
      requestStartTime=0;
      timer.textContent=totalTime+'s ‚úì';
      setTimeout(()=>timer.textContent='',3000);
      
      if(status<200||status>=300)return err('HTTP '+status);
      
      let d;
      try{
        d=JSON.parse(text);
      }catch{
        err('Failed to parse response');
        return;
      }
      
      const c=d.choices?.[0]?.message?.content;
      if(!c){
        err('No content in response');
        return;
      }
      
      let o;
      try{
        o=JSON.parse(c);
      }catch{
        err('Invalid JSON in content');
        return;
      }
      
      let display='',extra='';
      
      if(o.answer!==undefined){
        display=String(o.answer);
        extra=o.work?' ‚Äî '+o.work:'';
      }else if(o.result_number!==undefined){
        display=String(o.result_number);
      }
      
      workingBig.textContent=display||'No answer';
      workingRat.textContent=extra;
      lockedBig.textContent=display||'No answer';
      lockedRat.textContent=extra;
      lockedAnswer=display;
      lockedHash=cur;
      setProgress(100);
      setState('nonew');
    }

    setInterval(()=>{
      if(v.paused||v.ended){
        console.log('Camera frozen, restarting...');
        startCam();
      }
    },10000);
  </script>
</body>
</html>
