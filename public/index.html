<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Screenrada ‚Äì Vision AI</title>
  <style>
    :root{--bg:#0b0b0c;--ink:#fff;--muted:#9aa0a6;--panel:#121316;--stroke:#2a2b2f;--brand:#2c7be5;--ok:#0fa77a;--err:#e55353}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,sans-serif}
    .app{height:100dvh;display:grid;grid-template-rows:1fr 1.05fr}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .bottom{padding:10px;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{font-size:12px;opacity:.9}
    .panes{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pane{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .big{font-weight:800;font-size:28px}.muted{opacity:.9;font-size:12px}
    .answer{border:1px solid var(--stroke);border-radius:10px;padding:10px;background:#0e0f12;min-height:80px}
    .pbar{position:relative;width:200px;height:6px;border-radius:999px;background:#1a1b1f;border:1px solid #2a2b2f;overflow:hidden}
    .pbar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),#6aa6ff);transition:width .1s}
    .err{color:var(--err)}@media(max-width:800px){.panes{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <section class="top"><video id="cam" autoplay playsinline muted></video></section>
    <section class="bottom">
      <div class="row meta" style="gap:12px">
        <span id="emoji">üí§ Idle</span><span id="hashNote"></span><span id="cooldownNote"></span>
        <div class="pbar"><i id="pfill"></i></div><span id="ppct">0%</span>
        <span id="net" style="margin-left:auto">Status: idle</span>
      </div>
      <div class="panes">
        <div class="pane"><div class="muted">Working</div><div id="workingBig" class="answer big">No response</div><div id="workingRat" class="answer muted"></div></div>
        <div class="pane"><div class="muted">Locked</div><div id="lockedBig" class="answer big">‚Äì</div><div id="lockedRat" class="answer muted"></div></div>
      </div>
    </section>
  </div>

  <canvas id="frame" width="640" height="480" style="display:none"></canvas>
  <script>
    const v=document.getElementById('cam'),f=document.getElementById('frame'),ctx=f.getContext('2d');
    const workingBig=document.getElementById('workingBig'),workingRat=document.getElementById('workingRat');
    const lockedBig=document.getElementById('lockedBig'),lockedRat=document.getElementById('lockedRat');
    const emoji=document.getElementById('emoji'),hashNote=document.getElementById('hashNote'),cooldownNote=document.getElementById('cooldownNote');
    const pfill=document.getElementById('pfill'),ppct=document.getElementById('ppct'),net=document.getElementById('net');
    const GRID=8,CHANGE_THRESHOLD=.12,NEW_Q_THRESHOLD=.2,STABLE_FRAMES=3,MIN_INTERVAL_MS=2500,MAX_SEND_WIDTH=1280;
    let busy=false,lastSent=0,stableCount=0,lastHash='',lockedHash='',lockedAnswer=null;

    function paintNet(){net.textContent=navigator.onLine?'Status: online':'Status: offline';net.classList.toggle('err',!navigator.onLine)}
    addEventListener('online',paintNet);addEventListener('offline',paintNet);paintNet();

    function setState(k,extra=''){const m={asking:'ü§ñ Asking AI‚Ä¶',newq:'üÜï New question ‚Äî asking‚Ä¶',nonew:'üîí No new question',error:'‚ùå Error',idle:'üí§ Idle'};emoji.textContent=m[k]||'‚ÑπÔ∏è';if(extra)emoji.textContent+=' '+extra}
    async function startCam(){try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}});v.srcObject=s;await v.play();f.width=v.videoWidth||640;f.height=v.videoHeight||480;setState('idle');loop()}catch(e){alert('Camera permission or HTTPS required');console.error(e)}}
    startCam();

    function getHash(){const w=f.width,h=f.height,cw=Math.floor(w/GRID),ch=Math.floor(h/GRID),img=ctx.getImageData(0,0,w,h).data;let o='';for(let gy=0;gy<GRID;gy++)for(let gx=0;gx<GRID;gx++){let s=0,c=0,sy=gy*ch,sx=gx*cw;for(let y=sy;y<sy+ch&&y<h;y++)for(let x=sx;x<sx+cw&&x<w;x++){const i=(y*w+x)*4;s+=(img[i]+img[i+1]+img[i+2])/3;c++}o+=Math.floor(s/c/32)}return o}
    function diffHash(a,b){if(!a||!b||a.length!==b.length)return 1;let d=0;for(let i=0;i<a.length;i++)if(a[i]!==b[i])d++;return d/a.length}
    const cooldownLeft=()=>Math.max(0,MIN_INTERVAL_MS-(Date.now()-lastSent));
    function toBase64(){const sw=f.width,sc=Math.min(1,MAX_SEND_WIDTH/sw);if(sc===1)return f.toDataURL('image/png').split(',')[1];const tw=Math.round(f.width*sc),th=Math.round(f.height*sc);const o=document.createElement('canvas');o.width=tw;o.height=th;o.getContext('2d').drawImage(f,0,0,tw,th);return o.toDataURL('image/png').split(',')[1];}
    function setProgress(p){pfill.style.width=p+'%';ppct.textContent=p+'%'}
    function loop(){ctx.drawImage(v,0,0,f.width,f.height);const h=getHash(),d=diffHash(h,lastHash);hashNote.textContent=`Œî ${Math.round(d*100)}%`;if(!busy){if(cooldownLeft()>0)cooldownNote.textContent=`‚è± ${Math.ceil(cooldownLeft()/1000)}s`;else{cooldownNote.textContent='';if(d<CHANGE_THRESHOLD){if(++stableCount>=STABLE_FRAMES){const n=lockedHash&&diffHash(h,lockedHash)>NEW_Q_THRESHOLD;setState(n?'newq':'asking');send(h);stableCount=0}}else{stableCount=0;if(lockedAnswer)setState('nonew',`(${Math.round(d*100)}%)`)}}}lastHash=h;requestAnimationFrame(loop)}

    async function send(cur, retry=false){busy=true;lastSent=Date.now();setProgress(0);const base=toBase64();
      try{
        const xhr=new XMLHttpRequest();xhr.open('POST','/ask');xhr.setRequestHeader('Content-Type','application/json');
        xhr.upload.onprogress=e=>{if(e.lengthComputable){setProgress(Math.round(e.loaded/e.total*100))}};
        xhr.onload=()=>handle(xhr.status,xhr.responseText,cur);
        xhr.onerror=()=>{if(!retry){console.warn("Retrying once...");setTimeout(()=>send(cur,true),1500);}else err('Upload failed twice')};
        xhr.send(JSON.stringify({imageBase64:base}));
      }catch(e){err(e.message)}
    }

    function err(msg){busy=false;workingBig.textContent='Error';workingRat.textContent=msg;setState('error',msg)}
    function handle(status,text,cur){busy=false;if(status<200||status>=300)return err('HTTP '+status);
      let d;try{d=JSON.parse(text)}catch{d={error:text}};const c=d.choices?.[0]?.message?.content||'{}';let o={};try{o=JSON.parse(c)}catch{o={answer:c}};let display='',extra='';
      if(o.result_number!==undefined){display=String(o.result_number);if(o.consistency==='match'&&o.selection?.letter)extra=` (option ${o.selection.letter})`;else if(o.consistency==='no_match')extra=' ‚ö† no match';}
      else if(o.answer)display=o.answer;
      workingBig.textContent=display||'No answer';workingRat.textContent=(o.rationale||'')+extra;
      lockedBig.textContent=display||'No answer';lockedRat.textContent=(o.rationale||'')+extra;
      lockedAnswer=display;lockedHash=cur;setProgress(100);setState('nonew')}
  </script>
</body>
</html>
