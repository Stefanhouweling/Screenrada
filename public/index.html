<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Screenrada – Scroll-to-Capture</title>
  <style>
    body{margin:0;background:#0b0b0c;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;gap:1rem;padding:1rem}
    video{width:90vw;max-width:800px;border-radius:10px;background:#000}
    #status{font-size:16px;opacity:.9}
    #link a{color:#2c7be5;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <h2>📷 Screenrada — Auto Snapshot</h2>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="frame" style="display:none"></canvas>
  <div id="status">Initializing camera...</div>
  <div id="link">View console → <a href="/console" target="_blank">/console</a></div>

  <script>
    const v=document.getElementById('cam');
    const c=document.getElementById('frame');
    const ctx=c.getContext('2d',{willReadFrequently:true});
    const status=document.getElementById('status');
    let scrollTimer=null,busy=false;

    // Start camera
    async function startCam(){
      try{
        const s=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false
        });
        v.srcObject=s; await v.play();
        status.textContent='✅ Camera ready. Scroll to trigger snapshot.';
      }catch(e){
        status.textContent='❌ Camera error: '+e.message;
      }
    }

    // Capture full frame as PNG
    function captureBase64(){
      const w=v.videoWidth||1280, h=v.videoHeight||720;
      c.width=w; c.height=h;
      ctx.drawImage(v,0,0,w,h);
      return c.toDataURL('image/png').split(',')[1];
    }

    // Send to server → triggers console update
    async function sendImage(base64){
      busy=true;
      status.textContent='⏳ Sending to GPT-4o...';
      try{
        const r=await fetch('/ask',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({imageBase64:base64})
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        status.textContent='✅ Sent! Waiting for console update...';
      }catch(e){
        status.textContent='❌ Error: '+e.message;
      }
      busy=false;
    }

    // Scroll-stop detector
    window.addEventListener('scroll',()=>{
      if(scrollTimer) clearTimeout(scrollTimer);
      scrollTimer=setTimeout(()=>{
        if(!busy){
          const img=captureBase64();
          sendImage(img);
        }
      },1000);
    },{passive:true});

    startCam();
  </script>
</body>
</html>
